<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planner de Estudos Interativo</title>
    
    <!-- PWA and Mobile App Meta Tags -->
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Planner">
    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIlBsYW5uZXIgZGUgRXN0dWRvcyIsCiAgInNob3J0X25hbWUiOiAiUGxhbm5lciIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZTBhNWVjIiwKICAidGhlbWVfY29sb3IiOiAiIzRhNTBiYyIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbCwlM0NzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB3aWR0aD0nMTkyJyBoZWlnaHQ9JzE5Micgdmlld0JveD0nMCAwIDI0IDI0JyBmaWxsPSdub25lJyBzdHJva2U9JyUyMzRhNTBiYyIgc3Ryb2tlLXdpZHRoPScyJyBzdHJva2UtbGluZWNhcD0ncm91bmQnIHN0cm9rZS1saW5lam9pbj0ncm91bmQnIGNsYXNzPSdmZWF0aGVyIGZlYXRoZXItYm9vay1vcGVuJyUzRSUzQ3BhdGggZD0nTTIgM2g2YTQgNCAwIDAgMSA0IDR2MTRhMyAzIDAgMCAwLTMtM0gyeicgLzUzRSUzQ3BhdGggZD0nTTIyIDNoLTZhNCA0IDAgMCAwLTQgNHYxNGEzIDMgMCAwIDEgMy0zaDd6JyAvJTNFJTNDL3N2ZyUzRSIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiLAogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIKICAgIH0sCiAgICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbCwlM0NzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB3aWR0aD0nNTEyJyBoZWlnaHQ9JzUxMicgdmlld0JveD0nMCAwIDI0IDI0JyBmaWxsPSdub25lJyBzdHJva2U9JyUyMzRhNTBiYyIgc3Ryb2tlLXdpZHRoPScyJyBzdHJva2UtbGluZWNhcD0ncm91bmQnIHN0cm9rZS1saW5lam9pbj0ncm91bmQnIGNsYXNzPSdmZWF0aGVyIGZlYXRoZXItYm9vay1vcGVuJyUzRSUzQ3BhdGggZD0nTTIgM2g2YTQgNCAwIDAgMSA0IDR2MTRhMyAzIDAgMCAwLTMtM0gyeicgLzUzRSUzQ3BhdGggZD0nTTIyIDNoLTZhNCA0IDAgMCAwLTQgNHYxNGEzIDMgMCAwIDEgMy0zaDd6JyAvJTNFJTNDL3N2ZyUzRSIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiLAogICAgICAic2l6ZXMiOiAiNTEyeDUxMiIKICAgIH0KICBdCn0K">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #e0e5ec;
            --light-shadow: #ffffff;
            --dark-shadow: #a3b1c6;
            --accent-color: #4a50bc;
            --text-color: #5c677b;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        .neumorphic-out {
            border-radius: 20px;
            background: var(--bg-color);
            box-shadow: 8px 8px 15px var(--dark-shadow), -8px -8px 15px var(--light-shadow);
        }
        .neumorphic-btn {
            border-radius: 10px;
            background: var(--bg-color);
            box-shadow: 5px 5px 10px var(--dark-shadow), -5px -5px 10px var(--light-shadow);
            transition: all 0.1s ease-in-out;
        }
        .neumorphic-btn:hover {
             box-shadow: 2px 2px 5px var(--dark-shadow), -2px -2px 5px var(--light-shadow);
        }
        .neumorphic-btn:active {
            box-shadow: inset 2px 2px 5px var(--dark-shadow), inset -2px -2px 5px var(--light-shadow);
        }
        .link-icon {
            display: inline-block;
            width: 1em;
            height: 1em;
            margin-left: 0.25rem;
            vertical-align: -0.125em;
        }
        .custom-checkbox {
            -webkit-appearance: none;
            appearance: none;
            background-color: var(--bg-color);
            border-radius: 5px;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            box-shadow: 3px 3px 6px var(--dark-shadow), -3px -3px 6px var(--light-shadow);
        }
        .custom-checkbox:checked {
            box-shadow: inset 2px 2px 5px var(--dark-shadow), inset -2px -2px 5px var(--light-shadow);
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='%234a50bc' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
        }
        .task-text.completed {
            text-decoration: line-through;
            opacity: 0.6;
            color: var(--text-color);
        }
        .progress-track {
            background: var(--bg-color);
            border-radius: 9999px;
            box-shadow: inset 2px 2px 5px var(--dark-shadow), inset -2px -2px 5px var(--light-shadow);
        }
        .progress-fill {
            background-color: var(--accent-color);
            border-radius: 9999px;
        }
        .neu-select {
            -webkit-appearance: none;
            appearance: none;
            background-color: var(--bg-color);
            border: none;
            padding: 0.625rem; /* p-2.5 */
            border-radius: 8px; /* rounded-lg */
            box-shadow: 3px 3px 6px var(--dark-shadow), -3px -3px 6px var(--light-shadow);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' class='h-5 w-5' viewBox='0 0 20 20' fill='%235c677b'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd' /%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.5em 1.5em;
        }
        .code-block {
            background-color: rgba(0,0,0,0.05);
            padding: 1rem;
            border-radius: 8px;
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 0.875rem;
            border: 1px solid rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- Overlay Screen for errors and loading -->
    <div id="overlay-screen" class="fixed inset-0 flex items-center justify-center z-50 bg-gray-900 bg-opacity-75">
        <div class="neumorphic-out p-8 rounded-lg max-w-lg w-full mx-4 text-left">
             <h3 id="overlay-title" class="text-2xl font-bold mb-4" style="color: var(--accent-color);">A carregar...</h3>
             <div id="overlay-content" class="text-sm" style="color: var(--text-color);">A verificar a sua sessão...</div>
        </div>
    </div>


    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 flex items-center justify-center z-40 hidden">
        <div class="neumorphic-out p-8 rounded-lg max-w-md w-full mx-4 text-center">
            <h3 class="text-2xl font-bold mb-2" style="color: var(--accent-color);">Bem-vindo(a)</h3>
            <p class="mb-8" style="color: var(--text-color);">Aceda ao seu planner de estudos.</p>
            <button id="google-login-btn" class="neumorphic-btn w-full py-3 px-4 flex items-center justify-center font-semibold" style="color: var(--text-color);">
                <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"/><path fill="#FF3D00" d="M6.306 14.691c-1.242 1.83-1.999 3.98-1.999 6.309s.757 4.479 1.999 6.309l-5.657 5.657C.653 30.738 0 27.498 0 24s.653-6.738 1.909-9.309l5.657 5.657z"/><path fill="#4CAF50" d="M24 48c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 40.636 26.714 42 24 42c-4.836 0-8.991-3.328-10.43-7.828l-6.313 5.395C9.728 44.594 16.324 48 24 48z"/><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"/></svg>
                Entrar com Google
            </button>
        </div>
    </div>

    <div id="main-container" class="container mx-auto p-4 md:p-8 hidden">
        
        <header class="text-center mb-12">
            <h1 class="text-3xl md:text-5xl font-bold pb-2" style="color: var(--text-color);">Planner de Estudos Anual</h1>
            <p id="welcome-message" class="mt-2 text-lg" style="color: var(--text-color); opacity: 0.8;">Acompanhe seu progresso...</p>
        </header>

        <div class="neumorphic-out p-6 mb-8">
            <h2 class="text-xl font-semibold text-center mb-4" style="color: var(--text-color);">Progresso Geral do Cronograma</h2>
            <div class="w-full">
                <div class="flex justify-between mb-1">
                    <span class="text-base font-medium" style="color: var(--accent-color);">Total</span>
                    <span id="overall-progress-text" class="text-sm font-medium" style="color: var(--accent-color);">0%</span>
                </div>
                <div class="w-full h-4 progress-track">
                    <div id="overall-progress-bar" class="h-4 progress-fill transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div class="neumorphic-out p-6 mb-8 sticky top-4 z-10">
            <h2 class="text-xl font-semibold text-center mb-6" style="color: var(--text-color);">
                Em qual semana você está: <span id="current-week-display" class="font-bold" style="color: var(--accent-color);">1</span>
            </h2>
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div class="flex items-center gap-3">
                    <label for="week-selector" class="text-lg font-semibold" style="color: var(--text-color);">Semana:</label>
                    <select id="week-selector" class="neu-select text-sm w-24">
                    </select>
                </div>
                <div class="w-full md:w-1/2">
                    <div class="flex justify-between mb-1">
                        <span class="text-base font-medium" style="color: var(--accent-color);">Progresso da Semana</span>
                        <span id="progress-text" class="text-sm font-medium" style="color: var(--accent-color);">0%</span>
                    </div>
                    <div class="w-full h-2.5 progress-track">
                        <div id="progress-bar" class="h-2.5 progress-fill transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <main id="planner-content" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
        </main>
        
        <footer class="text-center mt-12" style="color: var(--text-color); opacity: 0.7;">
            <p>Criado com base no "Planner Anual - 52 Semanas - CDF".</p>
        </footer>

    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- INÍCIO: DADOS DO PLANNER ---
        const linkIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="link-icon" viewBox="0 0 20 20" fill="currentColor"><path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 001.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z" /><path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z" /></svg>`;
        const linkClass = `class="font-semibold hover:opacity-80 transition-opacity inline-flex items-center" style="color: var(--accent-color);" target="_blank" rel="noopener noreferrer"`;
        const plannerData = [
            { week: 1, days: [ { day: 1, tasks: ["Assista à aula 1.", "Faça o Quiz 1.", "Escreva um breve texto se apresentando, revelando seu nome, sua origem e o que você faz. Use os conhecimentos adquiridos em aula.", "Compartilhe o texto na nossa comunidade para nos conhecermos melhor."] }, { day: 2, tasks: ["Assista à aula 2.", "Faça o Quiz 2.", `Escreva entre 3 a 5 frases sobre o seu dia. Use o <a href="https://context.reverso.net/" ${linkClass}>Reverso Contexto${linkIcon}</a> ou <a href="https://www.collinsdictionary.com/" ${linkClass}>Collins${linkIcon}</a> se precisar.`, "Use o aplicativo Speak Aloud para treinar sua pronúncia. Insira cada frase do seu texto, ouça atentamente e repita em voz alta."] }, { day: 3, tasks: ["Assista à aula 3.", "Faça o Quiz 3.", `Acompanhe um canal gringo no <a href="https://www.youtube.com/" ${linkClass}>YouTube${linkIcon}</a>. Use a nossa lista de canais, acessando o módulo de introdução.`, "Assista ao vídeo que foi escolhido e tente identificar o tema principal ou palavras que já conhece."] }, { day: 4, tasks: ["Assista à aula 4.", "Faça o Quiz 4.", "Use este prompt para ter uma conversa com o Fluêncio, nosso chatbot: \"Hi! I'm [your name]. I am learning English. Let's talk!\"", "Você também pode pedir ao Fluêncio que corrija suas frases."] }, { day: 5, tasks: ["Assista à aula 5.", "Faça o Quiz 5.", `Aprenda com uma música usando o <a href="https://lyricstraining.com/" ${linkClass}>Lyricstraining${linkIcon}</a>. Procure por sua música favorita e selecione seu nível.`, "Anote algumas palavras novas da música e busque pelo seu significado. Crie frases de exemplo."] }, { day: 6, tasks: ["Assista à aula 6.", "Faça o Quiz 6.", `Procure vocabulários de objetos de um cômodo da sua casa usando o <a href="https://www.collinsdictionary.com/" ${linkClass}>dicionário Collins${linkIcon}</a>.`, "Cole notas adesivas nos objetos e faça frases com algumas das palavras que buscou."] }, { day: 7, tasks: ["Assista à aula 7.", "Faça o Quiz 7.", "Escreva um breve resumo sobre a sua semana em inglês e poste em nossa comunidade.", "Assista a um filme ou série em inglês. Tente focar na pronúncia e imitar o que está sendo falado."] } ]},
            { week: 2, days: [ { day: 8, tasks: ["Assista à aula 8.", "Faça o Quiz 8.", `Escolha uma receita no site <a href="https://tasty.co/" ${linkClass}>Tasty${linkIcon}</a>, leia seus ingredientes e método de preparo.`, "Use o aplicativo Speak Aloud para treinar a pronúncia das palavras novas."] }, { day: 9, tasks: ["Assista à aula 9.", "Faça o Quiz 9.", `Escreva sua receita favorita em inglês. Use o <a href="https://context.reverso.net/" ${linkClass}>Reverso Contexto${linkIcon}</a> ou <a href="https://www.collinsdictionary.com/" ${linkClass}>Collins${linkIcon}</a>.`, "Use o Speak Aloud para praticar a pronúncia das palavras que você estudou."] }, { day: 10, tasks: ["Assista à aula 10.", "Faça o Quiz 10.", `Escute a notícia <a href="https://www.newsinlevels.com/products/people-throw-away-food-level-1/" ${linkClass}>'People throw away food'${linkIcon}</a> (nível 1).`, "Leia a notícia, busque pelas palavras que não conhece e responda à pergunta nos comentários."] }, { day: 11, tasks: ["Assista à aula 11.", "Faça o Quiz 11.", `Assista a um tutorial de culinária em inglês no <a href="https://www.youtube.com/" ${linkClass}>YouTube${linkIcon}</a>. Pause o vídeo e repita em voz alta.`, "Anote os ingredientes e, se possível, reproduza o prato e compartilhe uma foto na comunidade."] }, { day: 12, tasks: ["Assista à aula 12.", "Faça o Quiz 12.", "Converse com o Fluêncio: \"Hi! What is your favorite food? I like [name of food]. Do you like it too?\"", `Expanda seu vocabulário no site <a href="https://www.eslgamesplus.com/" ${linkClass}>ESL Games${linkIcon}</a> com o tema "Food".`] }, { day: 13, tasks: ["Assista à aula 13.", "Faça o Quiz 13.", `Escute o Podcast <a href="https://learningenglish.voanews.com/a/let-s-learn-english-lesson-19-what-s-that-smell-/3415910.html" ${linkClass}>'The smell of coffee'${linkIcon}</a>. Leia o vocabulário e a transcrição.`, "Poste na comunidade se você gosta ou não de café e com que frequência você toma."] }, { day: 14, tasks: ["Assista à aula 14.", "Faça o Quiz 14.", "Assista a um programa de TV sobre culinária.", "Imagine que você é o apresentador. Escreva um mini-roteiro da receita que você ensinaria."] } ]},
            { week: 3, days: [ { day: 15, tasks: ["Assista à aula 15.", "Faça o Quiz 15.", "Crie uma lista de compras pesquisando o vocabulário de itens do seu dia-a-dia.", "Leia as embalagens dos produtos em inglês enquanto faz compras."] }, { day: 16, tasks: ["Assista à aula 16.", "Faça o Quiz 16.", `Explore o <a href="https://www.esl-lab.com/" ${linkClass}>ESL Lab${linkIcon}</a> para ouvir áudios em inglês sobre diferentes tópicos.`, `Navegue pela seção 'Listen & Watch' do <a href="https://www.bbc.co.uk/learningenglish" ${linkClass}>BBC Learning English${linkIcon}</a>.`] }, { day: 17, tasks: ["Assista à aula 17.", "Faça o Quiz 17.", `Assista a um vídeo tutorial sobre projetos DIY (Faça você mesmo) no <a href="https://www.youtube.com/" ${linkClass}>YouTube${linkIcon}</a>.`, `Explore comics e graphic novels em sites como <a href="https://www.gutenberg.org/" ${linkClass}>Project Gutenberg${linkIcon}</a> ou <a href="https://www.webtoons.com/" ${linkClass}>Webtoon${linkIcon}</a>.`] }, { day: 18, tasks: ["Assista à aula 18.", "Faça o Quiz 18.", `Faça a palavra cruzada do dia no site <a href="https://www.usatoday.com/crosswords" ${linkClass}>USA Today${linkIcon}</a>.`, "Escreva sua rotina em inglês (atividades matinais, trabalho, estudos e lazer)."] }, { day: 19, tasks: ["Assista à aula 19.", "Faça o Quiz 19.", "Leia em voz alta o e-mail ou carta que você escreveu.", `Pesquise por um restaurante famoso e explore seu site oficial.`] }, { day: 20, tasks: ["Assista à aula 20.", "Faça o Quiz 20.", "Converse com o Fluêncio sobre sua rotina: \"Hi! Let's talk about routine. Ask me some questions\".", "Escreva uma carta simples ou um e-mail para um amigo em inglês."] }, { day: 21, tasks: ["Assista à aula 21.", "Faça o Quiz 21.", "Crie cartões de memorização com palavras que você estudou recentemente.", "Imagine que está em um supermercado e escreva um diálogo pedindo ajuda para encontrar itens da sua lista."] } ]},
            { week: 4, days: [ { day: 22, tasks: ["Assista à aula 22.", "Faça o Quiz 22.", "Leia posts das redes sociais dos seus artistas favoritos.", "Assista 15 segundos de uma série ou filme sem legendas e anote o que entendeu."] }, { day: 23, tasks: ["Assista à aula 23.", "Faça o Quiz 23.", "Leia uma biografia curta de um dos seus artistas favoritos.", `Ouça diálogos simples no site <a href="https://www.elllo.org/" ${linkClass}>Elllo${linkIcon}</a>, selecionando o nível iniciante.`] }, { day: 24, tasks: ["Assista à aula 24.", "Faça o Quiz 24.", `Leia uma notícia sobre seu artista favorito em sites como <a href="https://people.com/" ${linkClass}>People${linkIcon}</a> ou <a href="https://www.eonline.com/" ${linkClass}>E! News${linkIcon}</a>.`, `Use o <a href="https://lyricstraining.com/" ${linkClass}>Lyrics Training${linkIcon}</a> para estudar com uma música de um artista que você gosta.`] }, { day: 25, tasks: ["Assista à aula 25.", "Faça o Quiz 25.", "Leia em voz alta um trecho de notícia ou post do seu artista.", `Escute uma entrevista em um podcast, como o <a href="https://armchairexpertpod.com/" ${linkClass}>The Armchair Expert${linkIcon}</a>.`] }, { day: 26, tasks: ["Assista à aula 26.", "Faça o Quiz 26.", "Escreva 3 frases sobre o seu dia e compartilhe na comunidade.", "Converse com o Fluêncio: \"Hello, Let's chat about [nome do artista]. Ask me questions about him/her.\""] }, { day: 27, tasks: ["Assista à aula 27.", "Faça o Quiz 27.", `Faça um quiz divertido no site <a href="https://www.eslgamesplus.com/" ${linkClass}>ESL Games${linkIcon}</a>.`, "Tente imitar a pronúncia do seu artista favorito, seja em músicas ou cenas de filmes."] }, { day: 28, tasks: ["Assista à aula 28.", "Faça o Quiz 28.", "Crie pelo menos 5 frases com as palavras que você aprendeu durante a semana.", "Procure por vocabulários de objetos do seu quarto e cole notas adesivas para memorizar."] } ]},
        ];
        function generateSampleData() { const existingWeeks = plannerData.length; for (let i = existingWeeks + 1; i <= 52; i++) { const weekData = { week: i, days: [] }; for (let j = 1; j <= 7; j++) { const dayNumber = (i - 1) * 7 + j; weekData.days.push({ day: dayNumber, tasks: [ `Assista à aula ${dayNumber}.`, `Faça o Quiz ${dayNumber}.`, `Atividade de escrita da semana ${i}, dia ${j}.`, `Atividade de escuta da semana ${i}, dia ${j}.`, `Atividade de conversação da semana ${i}, dia ${j}.` ] }); } plannerData.push(weekData); } }
        generateSampleData();
        // --- FIM: DADOS DO PLANNER ---
        
        const mainContainer = document.getElementById('main-container');
        const loginScreen = document.getElementById('login-screen');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const welcomeMessage = document.getElementById('welcome-message');
        const overlayScreen = document.getElementById('overlay-screen');
        const overlayTitle = document.getElementById('overlay-title');
        const overlayContent = document.getElementById('overlay-content');
        
        const weekSelector = document.getElementById('week-selector');
        const plannerContent = document.getElementById('planner-content');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const currentWeekDisplay = document.getElementById('current-week-display');
        
        let currentWeek = 1;
        let completionStatus = {};
        let userId = null;
        let db;
        let unsubscribe; // To detach the Firestore listener
        let dataLoaded = false; // Flag to prevent premature rendering

        // --- INÍCIO: LÓGICA DO FIREBASE ---

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'cronograma-flu-standalone';

        const firebaseConfig = {
            apiKey: "AIzaSyDtkw14S6v60cbjPKuqtzzQoCJRlzlR6w4",
            authDomain: "planner-de-estudos-ec7c4.firebaseapp.com",
            projectId: "planner-de-estudos-ec7c4",
            storageBucket: "planner-de-estudos-ec7c4.firebasestorage.app",
            messagingSenderId: "809041087779",
            appId: "1:809041087779:web:66819ca4f44a90f26a5096"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        function showOverlay(title, content) {
            overlayTitle.innerHTML = title;
            overlayContent.innerHTML = content;
            overlayScreen.classList.remove('hidden');
        }

        googleLoginBtn.addEventListener('click', () => {
            signInWithPopup(auth, provider).catch(error => {
                console.error("Google sign-in error", error);
                if (error.code === 'auth/unauthorized-domain') {
                    const currentDomain = window.location.hostname || 'o domínio atual';
                    showOverlay('Erro de Configuração', `...`); // Message hidden for brevity
                } else {
                    showOverlay('Erro de Autenticação', 'Ocorreu um erro inesperado. Tente novamente.');
                }
            });
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                welcomeMessage.textContent = `Olá, ${user.displayName || 'Estudante'}! A carregar o seu progresso...`;
                try {
                    await initializeUserData();
                    setupRealtimeListener();
                } catch (error) {
                    // Errors from initializeUserData are already handled by showing an overlay
                    console.error("Initialization failed, stopping.", error);
                }
            } else {
                userId = null;
                if (unsubscribe) unsubscribe();
                dataLoaded = false;
                mainContainer.classList.add('hidden');
                loginScreen.classList.remove('hidden');
                overlayScreen.classList.add('hidden');
            }
        });

        async function initializeUserData() {
            if (!userId) return;
            const docRef = doc(db, "artifacts", appId, "users", userId);
            try {
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) {
                    console.log("No existing data for this user, creating initial document.");
                    await setDoc(docRef, {
                        completionStatus: {},
                        currentWeek: 1
                    });
                }
            } catch (error) {
                 console.error("Error initializing user data:", error);
                 // This is the most likely failure point for the user's reported error.
                 // We will assume it's a security rules issue and guide them.
                 showSecurityRulesError();
                 throw error; // Propagate error to stop execution
            }
        }
        
        async function saveDataToFirestore() {
            if (!userId || !dataLoaded) return; 
            const docRef = doc(db, "artifacts", appId, "users", userId);
            try {
                await setDoc(docRef, { 
                    completionStatus: completionStatus,
                    currentWeek: currentWeek 
                }, { merge: true });
            } catch (e) {
                console.error("Error writing document: ", e);
                 if (e.code === 'permission-denied') {
                    showSecurityRulesError();
                }
            }
        }
        
        function setupRealtimeListener() {
            if (!userId) return;
            const docRef = doc(db, "artifacts", appId, "users", userId);
            
            if (unsubscribe) unsubscribe();

            unsubscribe = onSnapshot(docRef, (docSnap) => {
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    completionStatus = data.completionStatus || {};
                    currentWeek = data.currentWeek || 1;
                    
                    // Only render the full app once we are sure data is loaded
                    if (!dataLoaded) {
                        dataLoaded = true; // Set the flag
                        initializeAppState(); // Render for the first time
                    } else {
                        // For subsequent updates, just refresh the view
                        renderWeek(currentWeek);
                        updateOverallProgress();
                        calculateAndUpdateRealCurrentWeek();
                    }
                }
                
                overlayScreen.classList.add('hidden');
                loginScreen.classList.add('hidden');
                mainContainer.classList.remove('hidden');

            }, (error) => {
                console.error("Firestore snapshot error:", error);
                // If the listener itself fails, it's almost certainly a rules issue.
                showSecurityRulesError();
            });
        }

        function showSecurityRulesError() {
            showOverlay('Erro de Permissão na Base de Dados', `
                <p class="mb-4">A sua conta está autenticada, mas as regras de segurança do Firestore estão a impedir a leitura ou escrita do seu progresso.</p>
                <p class="mb-2"><strong>Ação Necessária:</strong></p>
                <ol class="list-decimal list-inside space-y-2 mb-4">
                    <li>Aceda à sua <a href="https://console.firebase.google.com/" target="_blank" rel="noopener noreferrer" class="font-bold underline" style="color: var(--accent-color);">Consola do Firebase</a>.</li>
                    <li>Vá para <strong>Build > Firestore Database > Rules</strong>.</li>
                    <li>Substitua o conteúdo existente por estas regras:</li>
                </ol>
                <div class="code-block">
                    rules_version = '2';<br>
                    service cloud.firestore {<br>
                    &nbsp;&nbsp;match /databases/{database}/documents {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;match /artifacts/{appId}/users/{userId} {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allow read, write: if request.auth != null && request.auth.uid == userId;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;}<br>
                    &nbsp;&nbsp;}<br>
                    }
                </div>
                 <p class="mt-4">Após guardar as novas regras, <strong>recarregue esta página</strong>.</p>
            `);
        }

        // --- FIM: LÓGICA DO FIREBASE ---

        function initializeAppState() {
            populateWeekSelector();
            renderWeek(currentWeek);
            updateOverallProgress();
            calculateAndUpdateRealCurrentWeek();
        }

        function populateWeekSelector() {
            weekSelector.innerHTML = '';
            plannerData.forEach(week => {
                const option = document.createElement('option');
                option.value = week.week;
                option.textContent = `${week.week}`;
                weekSelector.appendChild(option);
            });
            weekSelector.value = currentWeek;
        }

        function renderWeek(weekNumber) {
            const weekData = plannerData.find(w => w.week === parseInt(weekNumber, 10));
            if (!weekData) return;
            plannerContent.innerHTML = '';
            weekData.days.forEach(day => {
                const dayCard = document.createElement('div');
                dayCard.className = 'neumorphic-out p-6 flex flex-col gap-4';
                let tasksHtml = day.tasks.map((task, index) => {
                    const taskId = `w${weekNumber}-d${day.day}-t${index}`;
                    const isCompleted = completionStatus[taskId] || false;
                    return `<li class="flex items-start"><input id="${taskId}" type="checkbox" ${isCompleted ? 'checked' : ''} class="custom-checkbox h-5 w-5 mt-1 flex-shrink-0" data-task-id="${taskId}"><label for="${taskId}" class="ml-3"><span class="task-text ${isCompleted ? 'completed' : ''}">${task}</span></label></li>`;
                }).join('');
                dayCard.innerHTML = `<h2 class="text-xl font-bold border-b-2 pb-2 flex items-center gap-2" style="color: var(--text-color); border-color: rgba(163, 177, 198, 0.4)"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" style="color: var(--accent-color);" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>Dia ${day.day}</h2><ul class="space-y-4 pt-2">${tasksHtml}</ul>`;
                plannerContent.appendChild(dayCard);
            });
            updateProgress(weekNumber);
        }

        function updateProgress(weekNumber) {
            const weekData = plannerData.find(w => w.week === parseInt(weekNumber, 10));
            if (!weekData) return;
            let totalTasks = 0, completedTasks = 0;
            weekData.days.forEach(day => {
                totalTasks += day.tasks.length;
                day.tasks.forEach((task, index) => {
                    if (completionStatus[`w${weekNumber}-d${day.day}-t${index}`]) completedTasks++;
                });
            });
            const percentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            progressBar.style.width = `${percentage}%`;
            progressText.textContent = `${percentage}% completo`;
        }
        
        function calculateAndUpdateRealCurrentWeek() {
            let maxWeek = 0;
            for (const taskId in completionStatus) {
                if (completionStatus[taskId]) {
                    const weekNum = parseInt(taskId.split('-')[0].substring(1));
                    if (weekNum > maxWeek) maxWeek = weekNum;
                }
            }
            currentWeekDisplay.textContent = maxWeek > 0 ? maxWeek : 1;
        }

        function updateOverallProgress() {
            const totalTasks = plannerData.reduce((acc, week) => acc + week.days.reduce((dayAcc, day) => dayAcc + day.tasks.length, 0), 0);
            const completedTasks = Object.values(completionStatus).filter(status => status).length;
            const percentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            const overallProgressBar = document.getElementById('overall-progress-bar');
            const overallProgressText = document.getElementById('overall-progress-text');
            if (overallProgressBar && overallProgressText) {
                overallProgressBar.style.width = `${percentage}%`;
                overallProgressText.textContent = `${percentage}% completo`;
            }
        }

        weekSelector.addEventListener('change', (e) => {
            currentWeek = parseInt(e.target.value, 10);
            renderWeek(currentWeek);
            saveDataToFirestore();
        });

        plannerContent.addEventListener('change', (e) => {
            if (e.target.type === 'checkbox') {
                const taskId = e.target.dataset.taskId;
                completionStatus[taskId] = e.target.checked;
                const label = e.target.nextElementSibling;
                if (label) label.querySelector('.task-text').classList.toggle('completed', e.target.checked);
                
                saveDataToFirestore(); 
                
                updateProgress(currentWeek);
                updateOverallProgress();
                calculateAndUpdateRealCurrentWeek();
            }
        });
        
        document.body.style.backgroundColor = 'var(--bg-color)';
    </script>
</body>
</html>

